<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YOSOUKA Prediction Results</title>
  <style>
    :root {
      --bg0:#0b0f14; --card:#111821; --line:#1f2a36; --text:#e8eef6; --muted:#a9b4c0;
      --pill:#121c27; --teal:#2dd4bf;

      /* 金/銀 */
      --gold1: rgba(255, 215, 0, .90);
      --gold2: rgba(255, 215, 0, .30);
      --silver1: rgba(192, 192, 192, .90);
      --silver2: rgba(192, 192, 192, .25);
    }
    body {
      margin:0; padding:16px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background: radial-gradient(1200px 500px at 20% 0%, #0d1b2a 0%, var(--bg0) 55%) , var(--bg0);
      color:var(--text);
    }
    .top { display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    h1 { font-size:16px; margin:0; letter-spacing:.02em; }
    .meta { font-size:12px; color:var(--muted); }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill {
      background:var(--pill);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
    }
    select.pill { padding:8px 10px; max-width: 100%; }
    .btn {
      background:var(--pill);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
    }
    .btn.active { outline:2px solid rgba(255,215,0,.20); }
    .muted { color:var(--muted); font-size:12px; margin-top:8px; }
    .race-title { margin:14px 0 8px; font-size:13px; color:var(--text); }

    .horse {
      border:1px solid rgba(31,42,54,.9);
      border-radius:14px;
      padding:10px 10px;
      margin:10px 0;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
    }

    /* 着順外周（発光） */
    .horse.rank-1 {
      border-color: rgba(255,215,0,.95);
      box-shadow: 0 0 0 2px rgba(255,215,0,.18), 0 0 18px rgba(255,215,0,.12), 0 10px 30px rgba(0,0,0,.20);
    }
    .horse.rank-2 {
      border-color: rgba(192,192,192,.95);
      box-shadow: 0 0 0 2px rgba(192,192,192,.16), 0 0 18px rgba(192,192,192,.10), 0 10px 30px rgba(0,0,0,.20);
    }
    .horse.rank-3 {
      border-color: rgba(45,212,191,.95);
      box-shadow: 0 0 0 2px rgba(45,212,191,.14), 0 0 18px rgba(45,212,191,.10), 0 10px 30px rgba(0,0,0,.20);
    }

    .h-top {
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:8px;
    }
    .h-left { display:flex; align-items:center; gap:10px; min-width:0; }
    .badge {
      min-width:36px; height:30px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(31,42,54,.9);
      font-variant-numeric: tabular-nums;
      font-size:12px;
      font-weight:700;
    }

    /* 枠色（塗りつぶし寄せ） */
    .badge.waku-1 { background: rgba(255,255,255,.85); color:#0b0f14; }
    .badge.waku-2 { background: rgba(0,0,0,.80); color:#ffffff; }
    .badge.waku-3 { background: rgba(220,38,38,.80); color:#ffffff; }
    .badge.waku-4 { background: rgba(59,130,246,.80); color:#ffffff; }
    .badge.waku-5 { background: rgba(234,179,8,.85); color:#0b0f14; }
    .badge.waku-6 { background: rgba(16,185,129,.80); color:#0b0f14; }
    .badge.waku-7 { background: rgba(249,115,22,.85); color:#0b0f14; }
    .badge.waku-8 { background: rgba(236,72,153,.85); color:#0b0f14; }

    .h-name { font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .h-rank { font-size:12px; color:var(--muted); white-space:nowrap; }

    .barwrap {
      background: rgba(255,255,255,.04);
      border:1px solid rgba(31,42,54,.9);
      border-radius:12px;
      overflow:hidden;
    }
    .bar {
      height:26px;
      width:0%;
      display:flex;
      transition: width .2s ease;
    }
    .seg {
      display:flex; align-items:center;
      padding:0;
      white-space:nowrap;
      overflow:hidden;
    }
    .seg.honmei {
      background: linear-gradient(90deg, var(--gold1), var(--gold2));
    }
    .seg.otakara {
      background: linear-gradient(90deg, var(--silver1), var(--silver2));
    }

    .bar-meta {
      display:flex; justify-content:space-between; gap:10px;
      margin-top:6px;
      font-size:12px; color:rgba(255,255,255,.85);
      font-variant-numeric: tabular-nums;
    }
    .bar-meta .mut { color:var(--muted); }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>YOSOUKA Prediction Results</h1>
      <div class="meta">更新: 2026-01-25 16:57 / 対象: 最新5日</div>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <span class="pill">日付</span>
      <select id="dateSelect" class="pill"></select>

      <span class="pill">レース</span>
      <select id="raceSelect" class="pill"></select>
    </div>

    <div class="controls" style="margin-top:10px;">
      <span class="pill">ソート</span>
      <button class="btn active" data-key="総票">総票</button>
      <button class="btn" data-key="本命票">本命票</button>
      <button class="btn" data-key="馬番">馬番</button>
    </div>

    <div id="out" style="margin-top:10px;"></div>
    <div class="muted">※ 投票0の馬も表示します（バー内に0は表示しません）。</div>
  </div>

<script>
const RACES = [{"id": "20260125__京都11R__G2", "yyyymmdd": "20260125", "label": "20260125 京都11R G2", "place": "京都", "race_no": 11, "gclass": "G2", "rows": [{"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 13, "馬名": "ロードクロンヌ", "Gクラス": "G2", "本命票": 4, "お宝票": 1, "総票": 5, "Top3_pick": 0, "Top5_Label": "Top5: リーファ", "着順": "1", "is_win": 1, "is_place": 1}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 14, "馬名": "ハピ", "Gクラス": "G2", "本命票": 0, "お宝票": 5, "総票": 5, "Top3_pick": 0, "Top5_Label": "Top5: ソフトさん", "着順": "6", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 11, "馬名": "ペイシャエス", "Gクラス": "G2", "本命票": 2, "お宝票": 2, "総票": 4, "Top3_pick": 0, "Top5_Label": "", "着順": "8", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 12, "馬名": "シゲルショウグン", "Gクラス": "G2", "本命票": 2, "お宝票": 2, "総票": 4, "Top3_pick": 0, "Top5_Label": "", "着順": "13", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 2, "馬名": "サイモンザナドゥ", "Gクラス": "G2", "本命票": 3, "お宝票": 0, "総票": 3, "Top3_pick": 0, "Top5_Label": "", "着順": "9", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 9, "馬名": "ブライアンセンス", "Gクラス": "G2", "本命票": 2, "お宝票": 1, "総票": 3, "Top3_pick": 0, "Top5_Label": "Top5: スミレ", "着順": "4", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 1, "馬名": "ルシュヴァルドール", "Gクラス": "G2", "本命票": 0, "お宝票": 2, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "3", "is_win": 0, "is_place": 1}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 5, "馬名": "ハナウマビーチ", "Gクラス": "G2", "本命票": 0, "お宝票": 2, "総票": 2, "Top3_pick": 0, "Top5_Label": "Top5: ソフトさん", "着順": "12", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 6, "馬名": "クラウンプライド", "Gクラス": "G2", "本命票": 0, "お宝票": 2, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "15", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 8, "馬名": "マリオロード", "Gクラス": "G2", "本命票": 0, "お宝票": 2, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "16", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 10, "馬名": "ジェイパームス", "Gクラス": "G2", "本命票": 1, "お宝票": 0, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "7", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 7, "馬名": "テーオーパスワード", "Gクラス": "G2", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "10", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 15, "馬名": "セラフィックコール", "Gクラス": "G2", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "5", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 3, "馬名": "マーブルロック", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "11", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 4, "馬名": "テーオードレフォン", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "14", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "京都", "R": 11, "馬番": 16, "馬名": "サンデーファンデー", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "2", "is_win": 0, "is_place": 1}]}, {"id": "20260125__中山11R__G2", "yyyymmdd": "20260125", "label": "20260125 中山11R G2", "place": "中山", "race_no": 11, "gclass": "G2", "rows": [{"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 14, "馬名": "ドゥラドーレス", "Gクラス": "G2", "本命票": 9, "お宝票": 1, "総票": 10, "Top3_pick": 0, "Top5_Label": "Top5: スミレ", "着順": "2", "is_win": 0, "is_place": 1}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 5, "馬名": "マテンロウレオ", "Gクラス": "G2", "本命票": 3, "お宝票": 5, "総票": 8, "Top3_pick": 0, "Top5_Label": "", "着順": "4", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 3, "馬名": "マイネルエンペラー", "Gクラス": "G2", "本命票": 2, "お宝票": 3, "総票": 5, "Top3_pick": 0, "Top5_Label": "", "着順": "11", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 9, "馬名": "ショウヘイ", "Gクラス": "G2", "本命票": 3, "お宝票": 1, "総票": 4, "Top3_pick": 0, "Top5_Label": "Top5: しーいち 他2名", "着順": "1", "is_win": 1, "is_place": 1}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 1, "馬名": "チャックネイト", "Gクラス": "G2", "本命票": 1, "お宝票": 3, "総票": 4, "Top3_pick": 0, "Top5_Label": "", "着順": "13", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 10, "馬名": "ノースブリッジ", "Gクラス": "G2", "本命票": 0, "お宝票": 4, "総票": 4, "Top3_pick": 0, "Top5_Label": "Top5: ソフトさん", "着順": "8", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 4, "馬名": "ジョバンニ", "Gクラス": "G2", "本命票": 2, "お宝票": 1, "総票": 3, "Top3_pick": 0, "Top5_Label": "", "着順": "7", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 12, "馬名": "ディマイザキッド", "Gクラス": "G2", "本命票": 1, "お宝票": 2, "総票": 3, "Top3_pick": 0, "Top5_Label": "", "着順": "6", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 7, "馬名": "マイネルメモリー", "Gクラス": "G2", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "15", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 11, "馬名": "ニシノレヴナント", "Gクラス": "G2", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "9", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 16, "馬名": "エヒト", "Gクラス": "G2", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "3", "is_win": 0, "is_place": 1}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 2, "馬名": "ホウオウノーサイド", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "14", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 6, "馬名": "サンストックトン", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "5", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 8, "馬名": "アウスヴァール", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "16", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 13, "馬名": "アルビージャ", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "10", "is_win": 0, "is_place": 0}, {"日付": "20260125", "開催場": "中山", "R": 11, "馬番": 15, "馬名": "ファウストラーゼン", "Gクラス": "G2", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "12", "is_win": 0, "is_place": 0}]}, {"id": "20260124__小倉11R__G3", "yyyymmdd": "20260124", "label": "20260124 小倉11R G3", "place": "小倉", "race_no": 11, "gclass": "G3", "rows": [{"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 9, "馬名": "パレハ", "Gクラス": "G3", "本命票": 4, "お宝票": 4, "総票": 8, "Top3_pick": 0, "Top5_Label": "", "着順": "7", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 7, "馬名": "インヴォーグ", "Gクラス": "G3", "本命票": 1, "お宝票": 4, "総票": 5, "Top3_pick": 0, "Top5_Label": "", "着順": "6", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 17, "馬名": "ジョスラン", "Gクラス": "G3", "本命票": 4, "お宝票": 0, "総票": 4, "Top3_pick": 0, "Top5_Label": "Top5: しーいち 他1名", "着順": "1", "is_win": 1, "is_place": 1}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 8, "馬名": "ココナッツブラウン", "Gクラス": "G3", "本命票": 2, "お宝票": 1, "総票": 3, "Top3_pick": 0, "Top5_Label": "", "着順": "3", "is_win": 0, "is_place": 1}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 4, "馬名": "クリノメイ", "Gクラス": "G3", "本命票": 0, "お宝票": 3, "総票": 3, "Top3_pick": 0, "Top5_Label": "", "着順": "9", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 3, "馬名": "フレミングフープ", "Gクラス": "G3", "本命票": 1, "お宝票": 1, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "5", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 16, "馬名": "ボンドガール", "Gクラス": "G3", "本命票": 1, "お宝票": 1, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "2", "is_win": 0, "is_place": 1}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 1, "馬名": "テレサ", "Gクラス": "G3", "本命票": 0, "お宝票": 2, "総票": 2, "Top3_pick": 0, "Top5_Label": "", "着順": "4", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 5, "馬名": "アレナリア", "Gクラス": "G3", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "8", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 12, "馬名": "アンリーロード", "Gクラス": "G3", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "12", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 15, "馬名": "レディーヴァリュー", "Gクラス": "G3", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "15", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 18, "馬名": "パルクリチュード", "Gクラス": "G3", "本命票": 0, "お宝票": 1, "総票": 1, "Top3_pick": 0, "Top5_Label": "", "着順": "17", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 2, "馬名": "ブラウンラチェット", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "13", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 6, "馬名": "フィールシンパシー", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "10", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 10, "馬名": "タクシンイメル", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "18", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 11, "馬名": "エリカヴィータ", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "14", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 13, "馬名": "ウインエーデル", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "11", "is_win": 0, "is_place": 0}, {"日付": "20260124", "開催場": "小倉", "R": 11, "馬番": 14, "馬名": "クリスマスパレード", "Gクラス": "G3", "本命票": 0, "お宝票": 0, "総票": 0, "Top3_pick": 0, "Top5_Label": "", "着順": "16", "is_win": 0, "is_place": 0}]}];

function uniq(arr) {
  return Array.from(new Set(arr));
}
function byId(id) {
  return document.getElementById(id);
}

const dateSelect = byId("dateSelect");
const raceSelect = byId("raceSelect");
const out = byId("out");

let sortKey = "総票";
let sortDesc = true;

function buildDateOptions() {
  const dates = uniq(RACES.map(r => r.yyyymmdd)).sort().reverse();
  // ALLは作らない（最新が初期）
  dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join("");
}

function filteredRacesByDate() {
  const d = dateSelect.value;
  return RACES.filter(r => r.yyyymmdd === d);
}

function buildRaceOptions() {
  const filtered = filteredRacesByDate();
  raceSelect.innerHTML = filtered.map(r => `<option value="${r.id}">${r.label}</option>`).join("");

  // 初期選択は先頭
  if (raceSelect.options.length > 0) {
    raceSelect.selectedIndex = 0;
  }
}

function sortRows(rows) {
  const key = sortKey;
  const mul = sortDesc ? -1 : 1;

  return rows.slice().sort((a,b) => {
    const av = (a[key] === undefined || a[key] === null) ? 0 : a[key];
    const bv = (b[key] === undefined || b[key] === null) ? 0 : b[key];

    if (typeof av === "number" && typeof bv === "number") {
      if (av < bv) return -1 * mul;
      if (av > bv) return  1 * mul;
      // tie-break: 馬番 asc
      return (a["馬番"] - b["馬番"]);
    }

    const as = String(av);
    const bs = String(bv);
    if (as < bs) return -1 * mul;
    if (as > bs) return  1 * mul;
    return 0;
  });
}

function pctClamp(v) {
  if (isNaN(v)) return 0;
  return Math.max(0, Math.min(100, v));
}

function parseRankInt(v) {
  const s = String(v || "").trim();
  if (!s) return null;
  const n = parseInt(s, 10);
  return isNaN(n) ? null : n;
}

function renderOneRace(race) {
  const rows = sortRows(race.rows || []);

  const head = `<div class="race-title">${race.label}</div>`;

  if (!rows || rows.length === 0) {
    return head + "<div class='muted'>表示できる馬がありません。</div>";
  }

  const maxTotal = Math.max(1, ...rows.map(r => (r["総票"] || 0)));
  const maxUmaban = Math.max(1, ...rows.map(r => (r["馬番"] || 0)));

  // 馬番最大値から枠割当（基本：各枠2頭・最後枠に残り）
  function buildWakuMap(n) {
    const sizes = [];
    let remaining = n;

    for (let frame = 1; frame <= 8; frame++) {
      const minNeeded = 8 - frame;
      let size = remaining - minNeeded;

      if (size <= 0) size = 1;
      if (frame < 8) size = Math.min(2, size);
      if (frame === 8) size = remaining;

      sizes.push(size);
      remaining -= size;
    }

    const map = {};
    let ub = 1;
    sizes.forEach((sz, idx) => {
      const waku = idx + 1;
      for (let i = 0; i < sz; i++) {
        map[ub] = waku;
        ub++;
      }
    });
    return map;
  }

  const wakuMap = buildWakuMap(maxUmaban);

  const body = rows.map(r => {
    const rankText = r["着順"] ? r["着順"] : "";
    const rankInt = parseRankInt(rankText);

    let rankCls = "";
    if (rankInt === 1) rankCls = "rank-1";
    else if (rankInt === 2) rankCls = "rank-2";
    else if (rankInt === 3) rankCls = "rank-3";

    const total = (r["総票"] || 0);
    const honmei = (r["本命票"] || 0);
    const otakara = (r["お宝票"] || 0);

    const wTotal = pctClamp((total / maxTotal) * 100);
    const wHonmei = (total > 0) ? pctClamp((honmei / total) * 100) : 0;
    const wOtakara = (total > 0) ? pctClamp((otakara / total) * 100) : 0;

    // 0 は表示しない（必要なら「投票なし」でまとめる）
    const parts = [];
    if (honmei > 0) parts.push(`本命 ${honmei}`);
    if (otakara > 0) parts.push(`お宝 ${otakara}`);
    const rightText = (parts.length > 0) ? parts.join(" / ") : "投票なし";

    const umaban = (r["馬番"] || 0);
    const waku = wakuMap[umaban] || 1;

    const top5Label = (r["Top5_Label"] || "");
    const top5Html = top5Label
      ? `<span class="mut" style="margin-left:6px; font-size:11px; white-space:nowrap;">${top5Label}</span>`
      : "";

    // バー内に文字は出さない。0のセグメントは作らない
    let segs = "";
    if (honmei > 0) segs += `<div class="seg honmei" style="width:${wHonmei}%"></div>`;
    if (otakara > 0) segs += `<div class="seg otakara" style="width:${wOtakara}%"></div>`;

    return `<div class="horse ${rankCls}">
      <div class="h-top">
        <div class="h-left">
          <div class="badge waku-${waku}">${r["馬番"]}</div>
          <div class="h-name">${r["馬名"]}${top5Html}</div>
        </div>
        <div class="h-rank">着順: <span class="mut">${rankText}</span></div>
      </div>


      <div class="barwrap">
        <div class="bar" style="width:${wTotal}%">
          ${segs}
        </div>
      </div>

      <div class="bar-meta">
        <div>総票 <b>${total}</b></div>
        <div class="mut">${rightText}</div>
      </div>
    </div>`;
  }).join("");

  return head + body;
}

function render() {
  const id = raceSelect.value;
  if (!id) {
    out.innerHTML = "<div class='muted'>レースを選択してください。</div>";
    return;
  }
  const race = RACES.find(r => r.id === id);
  if (!race) {
    out.innerHTML = "<div class='muted'>レースが見つかりません。</div>";
    return;
  }
  out.innerHTML = renderOneRace(race);
}

dateSelect.addEventListener("change", () => {
  buildRaceOptions();
  render();
});

raceSelect.addEventListener("change", render);

document.querySelectorAll(".btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const key = btn.getAttribute("data-key");
    sortKey = key;

    // 馬番だけは昇順、それ以外は降順
    sortDesc = (key !== "馬番");
    render();
  });
});

buildDateOptions();
// 最新日を初期選択
if (dateSelect.options.length > 0) {
  dateSelect.selectedIndex = 0;
}
buildRaceOptions();
render();
</script>
</body>
</html>
